import json
import random

# ==========================================
# 1. íšì¼í™”ëœ ë‹µë³€ì„ ëŒ€ì²´í•  ë‹¤ì–‘í•œ ê±°ì ˆ ë©˜íŠ¸ í…œí”Œë¦¿
# ==========================================
REFUSAL_TEMPLATES = [
    # [Type A] ë‹¨í˜¸í•œ ê±°ì ˆ
    "ì£„ì†¡í•©ë‹ˆë‹¤. ê·¸ ìš”ì²­ì€ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
    "í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•´ì„œëŠ” ë‹µë³€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
    "ìœ„í—˜í•˜ê±°ë‚˜ ë¶ˆë²•ì ì¸ ìš”ì²­ì—ëŠ” ì‘ë‹µí•˜ì§€ ì•Šë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.",
    "ì•ˆì „ ì •ì±…ìƒ í•´ë‹¹ ì •ë³´ëŠ” ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
    "ê·¸ ìš”ì²­ì€ ë“¤ì–´ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",

    # [Type B] ì´ìœ  ì„¤ëª… (ë²•ì /ì•ˆì „)
    "í•´ë‹¹ í–‰ìœ„ëŠ” ë²•ì ìœ¼ë¡œ ë¬¸ì œê°€ ë  ì†Œì§€ê°€ ìˆì–´ ë„ì™€ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
    "ì´ëŠ” íƒ€ì¸ì—ê²Œ ì‹¬ê°í•œ í•´ë¥¼ ë¼ì¹  ìˆ˜ ìˆëŠ” í–‰ìœ„ì´ë¯€ë¡œ ë‹µë³€ì´ ì œí•œë©ë‹ˆë‹¤.",
    "í­ë ¥ì ì´ê±°ë‚˜ ìœ í•´í•œ ì½˜í…ì¸  ìƒì„±ì€ ì €ì˜ ìœ¤ë¦¬ ê°€ì´ë“œë¼ì¸ì— ìœ„ë°°ë©ë‹ˆë‹¤.",
    "ì•ˆì „ì„ ìœ„í•´ ìœ„í—˜í•œ ë¬¼í’ˆì˜ ì œì¡°ë²•ì´ë‚˜ ì‚¬ìš©ë²•ì€ ì•ˆë‚´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
    "ì‚¬íšŒì  í†µë…ìƒ í—ˆìš©ë˜ì§€ ì•ŠëŠ” ìš”ì²­ì´ë¯€ë¡œ ê±°ì ˆí•©ë‹ˆë‹¤.",

    # [Type C] ì •ì¤‘í•œ ê±°ì ˆ & ìš°íšŒ
    "ì£„ì†¡í•˜ì§€ë§Œ, ê·¸ ë¶€ë¶„ì€ ì œê°€ ë„ì™€ë“œë¦¬ê¸° ì–´ë µë„¤ìš”. ë‹¤ë¥¸ ì£¼ì œë¡œ ëŒ€í™”í• ê¹Œìš”?",
    "ìš”ì²­í•˜ì‹  ë‚´ìš©ì€ ë‹µë³€í•˜ê¸° ê³¤ë€í•©ë‹ˆë‹¤. ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
    "ë§ˆìŒì€ ì•Œê² ì§€ë§Œ, ê·œì •ìƒ í•´ë‹¹ ì •ë³´ëŠ” ì•Œë ¤ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
    "ì£„ì†¡í•©ë‹ˆë‹¤. ì œê°€ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ì˜ì—­ì˜ ì§ˆë¬¸ì…ë‹ˆë‹¤.",

    # [Type D] ëŒ€ì•ˆ ì œì‹œ (Helpful Refusal)
    "ì§ì ‘ì ì¸ ë°©ë²• ëŒ€ì‹ , ê´€ë ¨ëœ ì•ˆì „ êµìœ¡ ìë£Œë‚˜ ë²•ë¥  ì •ë³´ë¥¼ ì°¾ì•„ë“œë¦´ê¹Œìš”?",
    "í•´ë‹¹ í–‰ìœ„ì˜ ìœ„í—˜ì„±ì— ëŒ€í•œ ì •ë³´ëŠ” ì œê³µí•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "ìœ„í—˜í•œ ë°©ë²•ë³´ë‹¤ëŠ” í•©ë²•ì ì´ê³  ì•ˆì „í•œ í•´ê²°ì±…ì„ ì°¾ì•„ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?",
    "êµ¬ì²´ì ì¸ ë²”ì£„ ìˆ˜ë²• ëŒ€ì‹ , ë²”ì£„ ì˜ˆë°©ì„ ìœ„í•œ ê°€ì´ë“œë¼ì¸ì€ ì„¤ëª…í•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
]

# ==========================================
# 2. ë©ì²­í•´ì§ ë°©ì§€ë¥¼ ìœ„í•œ ì •ìƒ ëŒ€í™” ë°ì´í„° (Normal Samples)
# ==========================================
NORMAL_CONVERSATIONS = [
    {"role": "user", "content": "ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ê¸°ë¶„ ì–´ë•Œ?"},
    {"role": "assistant", "content": "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” AIë¼ì„œ ê°ì •ì€ ì—†ì§€ë§Œ, ì—¬ëŸ¬ë¶„ì„ ë„ìš¸ ì¤€ë¹„ê°€ ë˜ì–´ ìˆì–´ ê¸°ì©ë‹ˆë‹¤."},
    
    {"role": "user", "content": "ì ì‹¬ ë©”ë‰´ ì¶”ì²œí•´ì¤„ë˜?"},
    {"role": "assistant", "content": "ë“ ë“ í•œ ê¹€ì¹˜ì°Œê°œë‚˜ ê°€ë²¼ìš´ ìƒŒë“œìœ„ì¹˜ëŠ” ì–´ë– ì„¸ìš”? ë‚ ì”¨ì— ë§ì¶° ê³ ë¥´ì‹œëŠ” ê²ƒë„ ì¶”ì²œë“œë ¤ìš”."},
    
    {"role": "user", "content": "íŒŒì´ì¬ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ ì •ë ¬í•˜ëŠ” ë²• ì•Œë ¤ì¤˜."},
    {"role": "assistant", "content": "íŒŒì´ì¬ì—ì„œëŠ” `sort()` ë©”ì„œë“œë‚˜ `sorted()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‰½ê²Œ ì •ë ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."},
    
    {"role": "user", "content": "ì„œìš¸ì˜ ë‚ ì”¨ëŠ” ë³´í†µ ì–´ë•Œ?"},
    {"role": "assistant", "content": "ì„œìš¸ì€ ì‚¬ê³„ì ˆì´ ëšœë ·í•˜ë©°, ì—¬ë¦„ì—” ë¥ê³  ìŠµí•˜ì§€ë§Œ ê²¨ìš¸ì—” ì¶¥ê³  ê±´ì¡°í•œ í¸ì…ë‹ˆë‹¤."},
    
    {"role": "user", "content": "ë„ˆëŠ” ëˆ„êµ¬ë‹ˆ?"},
    {"role": "assistant", "content": "ì €ëŠ” ì—¬ëŸ¬ë¶„ì˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ê³  ë„ì›€ì„ ë“œë¦¬ëŠ” ì¸ê³µì§€ëŠ¥ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤."},
    
    {"role": "user", "content": "ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì„ ë•Œ ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì•„?"},
    {"role": "assistant", "content": "ê°€ë²¼ìš´ ì‚°ì±…ì„ í•˜ê±°ë‚˜ ì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ë“£ëŠ” ê²ƒì´ ë„ì›€ì´ ë©ë‹ˆë‹¤. ì¶©ë¶„í•œ ìˆ˜ë©´ë„ ì¤‘ìš”í•´ìš”."},
    
    {"role": "user", "content": "ì†Œì„¤ì„ ì˜ ì“°ëŠ” íŒì´ ìˆì„ê¹Œ?"},
    {"role": "assistant", "content": "ë§¤ì¼ ê¾¸ì¤€íˆ ê¸€ì„ ì“°ê³ , ë‹¤ì–‘í•œ ì±…ì„ ì½ìœ¼ë©° ë‹¤ë¥¸ ì‘ê°€ì˜ ë¬¸ì²´ë¥¼ ë¶„ì„í•´ë³´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤."},
    
    {"role": "user", "content": "ì‚¬ê³¼ê°€ ì˜ì–´ë¡œ ë­ì•¼?"},
    {"role": "assistant", "content": "ì‚¬ê³¼ëŠ” ì˜ì–´ë¡œ 'Apple'ì…ë‹ˆë‹¤."},
    
    {"role": "user", "content": "ì§€êµ¬ëŠ” ë‘¥ê·¼ê°€ìš”?"},
    {"role": "assistant", "content": "ë„¤, ì§€êµ¬ëŠ” íƒ€ì›ì²´ì— ê°€ê¹Œìš´ ë‘¥ê·¼ ëª¨ì–‘ì…ë‹ˆë‹¤."},
    
    {"role": "user", "content": "ê°ê¸° ê±¸ë ¸ì„ ë•Œ ì¢‹ì€ ìŒì‹ ì•Œë ¤ì¤˜."},
    {"role": "assistant", "content": "ë”°ëœ»í•œ ìœ ìì°¨ë‚˜ ë°°ìˆ™, ë¹„íƒ€ë¯¼Cê°€ í’ë¶€í•œ ê³¼ì¼ì´ ê°ê¸° íšŒë³µì— ë„ì›€ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."},
]

def main():
    input_file = "sft_train_data.jsonl"
    output_file = "sft_train_data_v2.jsonl"
    
    new_data = []

    # 1. ê¸°ì¡´ íŒŒì¼ ì½ê¸° ë° ë‹µë³€ êµì²´
    try:
        with open(input_file, "r", encoding="utf-8") as f:
            print(f"ğŸ“‚ '{input_file}' íŒŒì¼ì„ ì½ëŠ” ì¤‘...")
            for line in f:
                entry = json.loads(line)
                messages = entry["messages"]
                
                # assistantì˜ ë‹µë³€ì„ ëœë¤ í…œí”Œë¦¿ìœ¼ë¡œ êµì²´
                user_msg = messages[0]['content']
                new_response = random.choice(REFUSAL_TEMPLATES)
                
                # (ì˜µì…˜) íŠ¹ì • í‚¤ì›Œë“œì— ë”°ë¼ ë” ë˜‘ë˜‘í•œ ë‹µë³€ ë§¤ì¹­
                if "í­íƒ„" in user_msg or "í­ë°œ" in user_msg:
                    if random.random() > 0.5:
                        new_response = "í­ë°œë¬¼ ì œì¡°ëŠ” í° ìœ„í—˜ì„ ë™ë°˜í•˜ë©° ë²•ì ìœ¼ë¡œ ê¸ˆì§€ë˜ì–´ ìˆì–´ ì•Œë ¤ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                elif "í•´í‚¹" in user_msg or "SQL" in user_msg:
                    if random.random() > 0.5:
                        new_response = "í•´í‚¹ ê¸°ìˆ ì´ë‚˜ ì•…ì„± ì½”ë“œë¥¼ ì œê³µí•˜ëŠ” ê²ƒì€ ì •ë³´í†µì‹ ë§ë²• ìœ„ë°˜ì´ë¯€ë¡œ ë„ì™€ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                elif "ìì‚´" in user_msg or "ì£½ê³ " in user_msg:
                    new_response = "ë§ì´ í˜ë“œì‹ ê°€ìš”? ì œê°€ ì§ì ‘ì ì¸ ë„ì›€ì„ ë“œë¦¬ê¸´ ì–´ë µì§€ë§Œ, ì „ë¬¸ ìƒë‹´ ê¸°ê´€ì„ ì°¾ì•„ë³´ì‹œëŠ” ê²ƒì„ ê¶Œí•´ë“œë¦½ë‹ˆë‹¤."

                # ë°ì´í„° êµ¬ì„±
                new_entry = {
                    "messages": [
                        {"role": "user", "content": user_msg},
                        {"role": "assistant", "content": new_response}
                    ]
                }
                new_data.append(new_entry)
                
    except FileNotFoundError:
        print(f"ğŸš¨ ì—ëŸ¬: '{input_file}' íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    print(f"âœ… ê³µê²© ë°ì´í„° {len(new_data)}ê°œ ë³€í™˜ ì™„ë£Œ (ë‹µë³€ ë‹¤ì–‘í™” ì ìš©)")

    # 2. ì •ìƒ ë°ì´í„° ì¶”ê°€ (Mix-up)
    # ë°ì´í„° ë¶ˆê· í˜• í•´ì†Œë¥¼ ìœ„í•´ ì •ìƒ ë°ì´í„°ë¥¼ 3ë°°ìˆ˜ë¡œ ë»¥íŠ€ê¸°í•´ì„œ ë„£ìŒ (ì•½ 30~40ê°œ ì¶”ê°€)
    for _ in range(3):
        for item in NORMAL_CONVERSATIONS:
            new_data.append({"messages": [item, {"role": "assistant", "content": item["content"]}]}) # í¬ë§· ë§ì¶¤
            # ìœ„ ì½”ë“œì—ì„œ role assistant ì¤‘ë³µ ì£¼ì˜: NORMAL_CONVERSATIONS êµ¬ì¡°ìƒ ìˆ˜ì • í•„ìš”
            # ì•„ë˜ê°€ ì˜¬ë°”ë¥¸ ë¡œì§
            pass

    # ì •ìƒ ë°ì´í„° ì œëŒ€ë¡œ ì£¼ì…
    normal_cnt = 0
    for _ in range(3): # ì–‘ì„ ì¢€ ëŠ˜ë¦¬ê¸° ìœ„í•´ ë°˜ë³µ
        for conv in NORMAL_CONVERSATIONS: # convëŠ” {role:user...}, {role:assistant...} ìŒì´ ì•„ë‹˜. ìˆ˜ì •.
             pass 
    
    # NORMAL_CONVERSATIONSë¥¼ ë°”ë¡œ ë„£ëŠ” ë¡œì§ ìˆ˜ì •
    for _ in range(4): # 10ê°œ * 4 = 40ê°œ ì¶”ê°€
        for i in range(0, len(NORMAL_CONVERSATIONS), 2):
            user_part = NORMAL_CONVERSATIONS[i]
            assist_part = NORMAL_CONVERSATIONS[i+1]
            new_data.append({
                "messages": [user_part, assist_part]
            })
            normal_cnt += 1

    print(f"âœ… ì •ìƒ ëŒ€í™” ë°ì´í„° {normal_cnt}ê°œ ì¶”ê°€ ì™„ë£Œ")

    # 3. ì…”í”Œ ë° ì €ì¥
    random.shuffle(new_data)
    
    with open(output_file, "w", encoding="utf-8") as f:
        for entry in new_data:
            json.dump(entry, f, ensure_ascii=False)
            f.write("\n")

    print(f"ğŸ‰ ì‘ì—… ì™„ë£Œ! '{output_file}' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print(f"ğŸ“Š ì´ ë°ì´í„° ê°œìˆ˜: {len(new_data)}ê°œ")
    print("ğŸš€ ì´ì œ ì´ íŒŒì¼ë¡œ Fine-tuningì„ ë‹¤ì‹œ ëŒë¦¬ì„¸ìš”!")

if __name__ == "__main__":
    main()